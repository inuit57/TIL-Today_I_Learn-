# 개요 
- 로드밸런싱에 대해서 정리한다. 

## 자료 참조 
- [기법 소개](https://co-no.tistory.com/22)
- [L4 로드밸런싱](https://finerss.tistory.com/entry/L4-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1) 


## L4 로드 밸런싱
```
L4의 핵심은 'IP, 포트, 세션' 을 기반으로한 
로드 밸런싱(Load Balancing)이다!
```
```
2022년 기준으로 엄청나게 많은 수의 사용자들이 접속하고 단일 서버만으로는
사용자들을 감당하는 것이 어려워졌습니다. 

이러한 상황에서 문제를 해결하기 위해서 나온 것이 L4 스위치를 통한 로드밸런싱입니다.
```

* L4 스위치 = 포트 + 로드밸런싱(물론 IP,세션도 중요합니다)

```
로드밸런싱은, 동일한 역할을 수행하는 서버 그룹을 VIP를 통해 관리하며, 
서버로 향하는 트래픽을 일단 VIP를 가진 L4스위치로 수신한 후 
분배정책에 따라 적절한 서버에 분배해 주는 것을 말합니다.
```

```
VIP는 Virtual IP의 약자로, 서버그룹의 대표 IP라 할 수 있습니다. 
이 VIP를 로드밸런싱을 수행하는 L4 스위치가 가지고 있습니다.
서버와 통신하고자 하는 클라이언트는 VIP를 향해 트래픽을 전송하고 
L4스위치가 이 트래픽을 받아 적절한 서버에 로드밸런싱 해주는 것이 
L4스위치의 역할입니다.

한마디로, L4 스위치는 부하분산 장비입니다.

요즘 웬만한 사이트는 서버 한 대로 사용자들의 트래픽을 감당하기 
어렵기 떄문에 동일한 역할을 수행하는 서버를 여러 대 두어서 사용자들의 
트래픽이 많아져도 유연하고 안정적으로 사이트를 운영하기 위해 
L4스위치를 통한 로드밸런싱을 하는걸로 알고 있습니다.
```

## 로드밸런싱 알고리즘

### 라운드 로빈 방식 (Round Robin Method)
- 서버로 들어온 요청을 순서대로 돌아가며 배정하는 방식. 
- 클라이언트의 요청을 순서대로 분배하기 때문에 서버들이 동일한 스펙을 갖고 있고, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합.

### 가중 라운드로빈 방식 (Weighted Round Robin Method)
- 각각의 서버마다 가중치(Weight)를 매기고 가중치가 높은 서버에 클라이언트 요청을 우선적으로 배분.
- 주로 서버의 트래픽 처리 능력이 상이한 경우 사용되는 로드밸런싱 방식.
- ex) 서버 A의 가중치: 5 / 서버 B의 가중치: 2
  => A 서버에 5개의 Request, B 서버에 2개의 Request 할당.

### IP 해시 방식 (IP Hash Method)
- 클라이언트의 IP 주소를 특정 서버로 매핑하여 요청을 처리하는 방식.
- 사용자의 IP를 *해싱(Hashing)하여 부하를 분산하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장.
- 경로가 보장되며, 접속자 수가 많을수록 분산 및 효율이 뛰어남.

* 해싱(Hasing) : 임의의 길이를 지닌 데이터를 고정된 길이의 데이터로 매핑하는 것, 또는 그러한 함수.

#### 문제점
- 만약 사용자들이 프록시서버를 사용하는 경우에는 요청이 들어오는 IP 주소가 동일한 여러 명의 사용자가 생길 수 있습니다.
- 프록시 서버 특성 상 외부로 보여지는 IP 주소는 모두 동일하게 보여지게 됩니다. 
- 이런 상황에서 IP 해시 방식을 사용할 경우, 한쪽 서버로 사용자들이 몰리게 될 수 있으며 정상적으로 로드밸런싱이 안될 수 있습니다. 

#### 대안
```
SSL이나 기타 다른 보안모듈을 이용해서 인증된 특정 사용자에 대해서 Cookie/DB에 기록 후
해당 사용자에 대해서만 세션을 유지하도록 한다. (단점 : performance 저하 및 기타 cost)

그래서 L7 스위치를 사용한다.

```

### 최소 연결 방식 (Least Connection Method)
- Request가 들어온 시점에 가장 적은 연결(세션) 상태를 보이는 서버에 우선적으로 트래픽을 할당.
- 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합.

### 최소 응답시간 방식 (Least Response Time Method)
- 서버의 현재 연결 상태와 응답시간(Response Time)을 모두 고려하여, 가장 짧은 응답 시간을 보내는 서버로 트래픽을 할당하는 방식.
- 각 서버들의 가용한 리소스와 성능, 처리중인 데이터 양 등이 상이할 경우 적합.

### 대역폭 방식 (Bandwidth Method)
- 서버들과의 대역폭을 고려하여 서버에 트래픽을 할당.
